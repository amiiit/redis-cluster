---
- hosts: redis
  sudo: yes
  tasks:
  - name: set authorized key
    authorized_key: user=vagrant key="{{ lookup('file', '/Users/amit/.ssh/id_rsa.pub') }}"
  - name: ensure github.com is a known host
    lineinfile:
      dest: /home/vagrant/.ssh/known_hosts
      create: yes
      state: present
      line: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
      regexp: "^github\\.com"
  - name: install git
    apt: name=git-core
  - name: install unzip
    apt: name=unzip
  - name: download redis unstable code
    get_url: url="https://github.com/antirez/redis/archive/unstable.zip" dest="{{ ansible_env.HOME }}/redis-unstable.zip" 
  - name: unarchive redis
    unarchive: copy=no src="{{ ansible_env.HOME }}/redis-unstable.zip" dest="{{ ansible_env.HOME}}"
  - name: Install Redis
    command: creates="/usr/local/bin/redis-server" chdir="{{ ansible_env.HOME }}/redis-unstable" make install
  - name: Create user redis
    user: name=redis system=yes home=/var/lib/redis shell=/bin/false
  - name: Copy redis config
    copy: src=files/redis.conf dest="{{ redis_home }}" owner=redis group=redis
    notify: Restart Redis
  - name: Configure Upstart for Redis
    copy: src=files/redis_upstart.conf dest=/etc/init/redis.conf

  handlers:
    - name: Restart Redis
      service: name=redis state=restarted